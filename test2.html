<html>
    <head>
        <link rel="stylesheet" type="text/css" href="css/loader.css">
        <script type='text/javascript' src="class/Base.js"></script>
        <script type='text/javascript' src="class/Element.js"></script>
        <script type='text/javascript' src="class/element/ViewArea.js"></script>
        <script type='text/javascript' src="class/element/InputArea.js"></script>
        <script type='text/javascript' src="class/element/AddForm.js"></script>
        <script type='text/javascript' src="class/element/PlanList.js"></script>
        <script type='text/javascript' src="class/element/PlanItem.js"></script>
        <script type='text/javascript' src="class/element/DoneList.js"></script>
        <script type='text/javascript' src="class/element/DoneItem.js"></script>
        <script type='text/javascript' src="class/DataManager.js"></script>
        <script type='text/javascript' src="class/data/TaskData.js"></script>
        <script type='text/javascript' src="class/Storage.js"></script>
    </head>
    <body>
        <div id="base"></div>
        <script>
            /**
             * こんな雰囲気で作ってみる
             * todoManager: {
             *   inputArea: {
             *     addForm: {
             *       text: タスク入力
             *       button: 登録
             *     }
             *   }
             *   viewArea: {
             *     planList: [
             *       {
             *         text: タスク
             *         button: 完了
             *         button: 削除
             *       }
             *     ]
             *     doneList: [
             *       {
             *         text: タスク
             *         button: 戻す
             *         button: 削除
             *       }
             *     ]
             *   }
             * }
             */
            // なんちゃってtodoManager
            let todo = new ClassElement('div');
            document.getElementById("base").appendChild(todo.element);
            (async () => {
                // データ管理クラスの生成
                let storage = new ClassStorage();
                let dataKey = "todo-001";
                let dm = new ClassDataManager(storage, dataKey);
                // データ取得
                await dm.load();
                // id管理
                let maxId = dm.maxId;
                // todoリストの生成
                let af = new ClassAddForm();
                let ia = new ClassInputArea(af);
                let pl = new ClassPlanList();
                let dl = new ClassDoneList();
                let va = new ClassViewArea(pl, dl);
                // todoリストに初期データをセット
                todo.appendChild(ia);
                todo.appendChild(va);
                for (let data of dm.each) {
                    switch(data.status) {
                        case ClassTaskData.STATUS_PLAN:
                            pl.addItem(data);
                        break;
                        case ClassTaskData.STATUS_DONE:
                            dl.addItem(data);
                        break;
                        default:
                            throw new Error(`指定されたステータス${data.status}が不正です。`);
                        break;
                    }
                }
                // イベント処理
                // 新しい計画を追加する
                todo.on("report_add_plan_item", (event) => {
                    (async () => {
                        let input, data, item;
                        // 新規データ作成
                        input = af.getInput();
                        af.initInput();
                        data = {};
                        data.id = ++maxId;
                        data.text = input.text;
                        data.status = ClassTaskData.STATUS_PLAN;
                        // 新規データ登録
                        dm.update(data);
                        await dm.save();
                        // 計画リストにタスク追加
                        pl.addItem(data);
                    })();
                });
                // 計画リストから完了リストへ移す
                todo.on("report_done_plan_item", (event) => {
                    (async () => {
                        let data, item, pos;
                        let targetId = event.detail.id;
                        // データのステータス更新
                        data = dm.select(targetId);
                        data.status = ClassTaskData.STATUS_DONE;
                        // 更新データの確定
                        dm.update(data);
                        await dm.save();
                        // タスクの移動
                        if (!pl.deleteItem(targetId) ) {
                            throw new Error(`指定のID[${targetId}]は計画リストに存在しません。`);
                        }
                        pos = dm.pos(targetId);
                        dl.addItem(data, pos);
                    })();
                });
                // 計画リストから削除する
                todo.on("report_delete_plan_item", (event) => {
                    (async () => {
                        let targetId = event.detail.id;
                        // データの削除
                        dm.delete(targetId);
                        await dm.save();
                        // タスクの削除
                        pl.deleteItem(targetId);
                    })();
                });
                // 完了リストから計画リストへ戻す
                todo.on("report_restore_done_item", (event) => {
                    (async () => {
                        let data, item;
                        let targetId = event.detail.id;
                        // データのステータス更新
                        data = dm.select(targetId);
                        data.status = ClassTaskData.STATUS_PLAN;
                        // 更新データの確定
                        dm.update(data);
                        await dm.save();
                        // タスクの移動
                        if (!dl.deleteItem(targetId) ) {
                            throw new Error(`指定のID[${targetId}]は完了リストに存在しません。`);
                        }
                        pos = dm.pos(targetId);
                        pl.addItem(data, pos);
                    })();
                });
                // 完了リストから削除する
                todo.on("report_delete_done_item", (event) => {
                    (async () => {
                        let targetId = event.detail.id;
                        // データの削除
                        dm.delete(targetId);
                        await dm.save();
                        // タスクの削除
                        dl.deleteItem(targetId);
                    })();
                });
            })();
        </script>
    </body>
</html>
